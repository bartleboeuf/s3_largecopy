name: Release

'on':
  push:
    tags:
      - v*

permissions:
  contents: write
  packages: write

jobs:
  # test:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Install Rust
  #       uses: dtolnay/rust-toolchain@stable

  #     - name: Cache Rust dependencies
  #       uses: Swatinem/rust-cache@v2

  #     - name: Run tests
  #       run: cargo test --release

  create-release:
    # needs: test
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false

  build:
    needs: create-release
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: linux-x86_64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            name: linux-aarch64
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            name: linux-x86_64-static
            static: true
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            name: linux-aarch64-static
            static: true
            use_cross: true
          - target: x86_64-apple-darwin
            os: macos-latest
            name: macos-x86_64
          - target: aarch64-apple-darwin
            os: macos-latest
            name: macos-aarch64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            name: windows-x86_64
            ext: .exe

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux gnu)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Configure cross-compilation (Linux aarch64 gnu)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          echo '[target.aarch64-unknown-linux-gnu]' >> ~/.cargo/config.toml
          echo 'linker = "aarch64-linux-gnu-gcc"' >> ~/.cargo/config.toml

      - name: Install musl-tools for x86_64 static builds
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Install cross for ARM static builds
        if: matrix.use_cross == true
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Build binary (Linux, macOS)
        if: matrix.target != 'x86_64-pc-windows-msvc' && matrix.static != true
        run: cargo build --release --target ${{ matrix.target }}

      - name: Build binary (Windows)
        if: matrix.target == 'x86_64-pc-windows-msvc'
        run: cargo build --release --target ${{ matrix.target }}

      - name: Build x86_64 static binary with cargo
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: cargo build --release --target ${{ matrix.target }}

      - name: Build ARM static binary with cross
        if: matrix.use_cross == true
        run: cross build --release --target ${{ matrix.target }}

      - name: Get binary name
        id: binary_name
        shell: bash
        run: |
          BINARY_NAME="s3_largecopy"
          echo "binary_name=${BINARY_NAME}" >> $GITHUB_OUTPUT

      - name: Strip binary (Unix)
        if: matrix.os != 'windows-latest'
        run: strip target/${{ matrix.target }}/release/${{ steps.binary_name.outputs.binary_name }}

      - name: Verify static binary
        if: matrix.static == true
        shell: bash
        run: file target/${{ matrix.target }}/release/${{ steps.binary_name.outputs.binary_name }}${{ matrix.ext }}

      - name: Show binary info
        shell: bash
        run: ls -lh target/${{ matrix.target }}/release/${{ steps.binary_name.outputs.binary_name }}${{ matrix.ext }}

      - name: Create archive
        id: archive
        shell: bash
        run: |
          BINARY_NAME="${{ steps.binary_name.outputs.binary_name }}"
          echo "BINARY_NAME=${BINARY_NAME}"
          BINARY_PATH="target/${{ matrix.target }}/release/${BINARY_NAME}${{ matrix.ext }}"
          echo "BINARY_PATH=${BINARY_PATH}"
          ARCHIVE_NAME="${BINARY_NAME}-${{ github.ref_name }}-${{ matrix.name }}"
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}"

          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            echo "Creating Windows archive"
            ARCHIVE_FILE="${ARCHIVE_NAME}.zip"
            echo "Creating archive: ${ARCHIVE_FILE}"
            cd target/${{ matrix.target }}/release
            7z a "../../../${ARCHIVE_FILE}" "${BINARY_NAME}${{ matrix.ext }}"
          else
            ls -ail target/${{ matrix.target }}/release
            echo "Creating non-Windows archive"
            ARCHIVE_FILE="${ARCHIVE_NAME}.tar.gz"
            echo "Creating archive: ${ARCHIVE_FILE}"
            tar -czf "${ARCHIVE_FILE}" -C "target/${{ matrix.target }}/release" "${BINARY_NAME}${{ matrix.ext }}"
          fi

          echo "archive_name=${ARCHIVE_FILE}" >> $GITHUB_OUTPUT
          echo "asset_path=${ARCHIVE_FILE}" >> $GITHUB_OUTPUT

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ${{ steps.archive.outputs.asset_path }}
          asset_name: ${{ steps.archive.outputs.archive_name }}
          asset_content_type: application/octet-stream

      - name: Generate checksum for asset
        shell: bash
        run: sha256sum ${{ steps.archive.outputs.archive_name }} >> checksums.txt

      - name: Upload checksum
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: checksums.txt
          asset_name: checksums_${{ matrix.name }}.txt
          asset_content_type: text/plain